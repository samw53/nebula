<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Coin Flip with Login</title>
  <style>
    body { font-family: Arial; text-align: center; padding: 2em; }
    input { margin: 5px; padding: 8px; }
    button { padding: 10px 15px; margin: 5px; }
    #game, #logoutBtn { display: none; }
    table { margin: auto; border-collapse: collapse; margin-top: 30px; }
    th, td { border: 1px solid #ccc; padding: 8px 12px; }
    th { background: #eee; }
  </style>
</head>
<body>

<h1>ü™ô Coin Flip Game</h1>

<!-- Auth -->
<div id="auth">
  <input type="text" id="usernameInput" placeholder="Enter username" />
  <button onclick="login()">Login / Sign Up</button>
</div>

<!-- Game -->
<div id="game">
  <p>Welcome, <span id="currentUser"></span>!</p>
  <button onclick="flipCoin()">Flip Coin</button>
  <div id="coin" style="font-size: 60px; margin: 20px;">‚ùì</div>
  <div id="result"></div>

  <h2>üèÜ Leaderboard</h2>
  <table>
    <thead><tr><th>Name</th><th>Wins</th></tr></thead>
    <tbody id="leaderboardBody"></tbody>
  </table>
</div>

<button id="logoutBtn" onclick="logout()">Logout</button>

<script>
  const BIN_ID = "683d94d68960c979a5a43641";
  const API_KEY = "$2a$10$y3RxWR0k1Hbs/87Ml9Hj8.8kryR.S0dCHpCYZ3h5lMKvd5qiXA/6C";
  const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
  const HEADERS = {
    "Content-Type": "application/json",
    "X-Master-Key": API_KEY
  };

  let currentUser = null;

  async function fetchData() {
    const res = await fetch(BASE_URL + "/latest", { headers: HEADERS });
    const json = await res.json();
    return json.record;
  }

  async function saveData(data) {
    await fetch(BASE_URL, {
      method: "PUT",
      headers: HEADERS,
      body: JSON.stringify(data)
    });
  }

  function renderLeaderboard(leaderboard) {
    const tbody = document.getElementById("leaderboardBody");
    tbody.innerHTML = "";
    leaderboard.sort((a, b) => b.wins - a.wins);
    leaderboard.forEach(user => {
      tbody.innerHTML += `<tr><td>${user.name}</td><td>${user.wins}</td></tr>`;
    });
  }

  async function login() {
    const username = document.getElementById("usernameInput").value.trim();
    if (!username) return alert("Enter a username.");

    let data = await fetchData();

    // Create structure if missing
    if (!data.users) data.users = [];
    if (!data.leaderboard) data.leaderboard = [];

    let userExists = data.users.find(u => u.username === username);
    if (!userExists) {
      data.users.push({ username });
      data.leaderboard.push({ name: username, wins: 0 });
      await saveData(data);
    }

    currentUser = username;
    document.getElementById("currentUser").textContent = currentUser;
    document.getElementById("auth").style.display = "none";
    document.getElementById("game").style.display = "block";
    document.getElementById("logoutBtn").style.display = "inline-block";

    renderLeaderboard(data.leaderboard);
  }

  async function flipCoin() {
    if (!currentUser) return;

    const result = Math.random() < 0.5 ? "Heads" : "Tails";
    document.getElementById("coin").textContent = result === "Heads" ? "üôÇ" : "üôÉ";
    document.getElementById("result").textContent = `${currentUser} got ${result}`;

    let data = await fetchData();
    let user = data.leaderboard.find(u => u.name === currentUser);
    if (user) user.wins += 1;

    await saveData(data);
    renderLeaderboard(data.leaderboard);
  }

  function logout() {
    currentUser = null;
    document.getElementById("auth").style.display = "block";
    document.getElementById("game").style.display = "none";
    document.getElementById("logoutBtn").style.display = "none";
    document.getElementById("usernameInput").value = "";
  }
</script>

</body>
</html>
